<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸–ç•ŒçµŒçœŒå€¤ãƒãƒƒãƒ—</title>
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.json">

  <!-- Service Worker ç™»éŒ² -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log("Service Worker registered"))
        .catch(err => console.log("SW registration failed:", err));
    }
  </script>
</head>

<body>
  <h1>ğŸŒ ä¸–ç•Œç‰ˆãƒãƒƒãƒ—</h1>

  <!-- åœ°å›³ã‚¨ãƒªã‚¢ -->
  <div id="map">
    <!-- SVGã¯åˆ¥ãƒ•ã‚¡ã‚¤ãƒ« (world-map.svg) ã‹ã‚‰èª­ã¿è¾¼ã¾ã‚Œã¾ã™ -->
  </div>

  <!-- åˆè¨ˆã‚¹ã‚³ã‚¢è¡¨ç¤º -->
  <div id="score">
    ç·ã‚¹ã‚³ã‚¢ï¼š<span id="totalScore">0</span>ç‚¹
  </div>

  <!-- ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
  <div class="button-area">
    <a href="world-edit.html" class="btn">âœï¸ ç·¨é›†</a>
    <a href="index.html" class="btn">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
  </div>

  <!-- jsãƒ©ã‚¤ãƒ–ãƒ©ãƒª(svg-pan-zoom) -->
  <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>

  <!-- ä¸–ç•Œåœ°å›³å‡¦ç†ï¼ˆå®Œå…¨ç‰ˆï¼‰ -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const mapDiv = document.getElementById('map');
      const totalScoreEl = document.getElementById('totalScore');

      // å›½åï¼ˆè¡¨ç¤ºåï¼‰ â†’ SVGå†…ã®è¦ç´ ID ã®å¯¾å¿œè¡¨
      const countryIdMap = {
        "æ—¥æœ¬": "JP",
        "ã‚¢ãƒ¡ãƒªã‚«": "US",
        "ãƒ•ãƒ©ãƒ³ã‚¹": "FR",
        "ä¸­å›½": "CN",
        "ãƒ–ãƒ©ã‚¸ãƒ«": "BR"
      };

      // è‰²ã¨ã‚¹ã‚³ã‚¢ã®å®šç¾©
      const colors = {
        "æœªè¸": "#f0f0f0",
        "çµŒç”±": "#b3e5fc",
        "è¨ªå•": "#81c784",
        "å®¿æ³Š": "#f48fb1"
      };
      const scores = { "æœªè¸":0, "çµŒç”±":1, "è¨ªå•":2, "å®¿æ³Š":3 };

      // SVGã‚’èª­ã¿è¾¼ã¿ã€DOMã«æŒ¿å…¥ã—ã¦åˆæœŸåŒ–ã™ã‚‹
      fetch('world-map.svg')
        .then(res => {
          if (!res.ok) throw new Error('SVGã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + res.status);
          return res.text();
        })
        .then(svgData => {
          mapDiv.innerHTML = svgData;

          // SVG è¦ç´ ã‚’å–å¾—
          const svgElement = document.getElementById('worldSVG');
          if (!svgElement) {
            console.warn('worldSVG è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚SVGå†…ã« id="worldSVG" ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          }

          // localStorage ã‹ã‚‰çŠ¶æ…‹ã‚’å–å¾—ï¼ˆç·¨é›†ãƒšãƒ¼ã‚¸ã§ä¿å­˜ã—ãŸã‚‚ã®ï¼‰
          const countryStatus = JSON.parse(localStorage.getItem('countryStatus')) || {};

          // ç·ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ã—ã¤ã¤ã€SVGä¸Šã®è‰²ã‚’æ›´æ–°
          let total = 0;
          for (const [country, level] of Object.entries(countryStatus)) {
            const id = countryIdMap[country];
            if (!id) continue; // å¯¾å¿œè¡¨ã«ãªã„å›½ã¯ã‚¹ã‚­ãƒƒãƒ—
            const el = document.getElementById(id);
            if (el) {
              const fill = colors[level] || colors["æœªè¸"];
              // SVGè¦ç´ ã«è‰²ã‚’åæ˜ ï¼ˆfillå±æ€§ã‚’ä½¿ã†ï¼‰
              el.setAttribute('fill', fill);
            }
            total += scores[level] || 0;
          }
          totalScoreEl.textContent = total;

          // SVGä¸Šã®è‰²ã‚’ã€ã‚‚ã— status ã«ç„¡ã„å›½ãŒã‚ã‚Œã°æœªè¸ã§åˆæœŸåŒ–ï¼ˆä»»æ„ï¼‰
          // ï¼ˆå¿…è¦ãªã‚‰ã“ã“ã§å…¨å›½ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰²ã‚’å…¥ã‚Œã‚‹å‡¦ç†ã‚’è¿½åŠ å¯èƒ½ï¼‰

          // svg-pan-zoom ã®åˆæœŸåŒ–ï¼ˆSVGãŒDOMã«è¿½åŠ ã•ã‚ŒãŸå¾Œã§å®Ÿè¡Œï¼‰
          try {
            if (svgElement && typeof svgPanZoom === 'function') {
              svgPanZoom(svgElement, {
                zoomEnabled: true,
                controlIconsEnabled: true,
                fit: true,
                center: true,
                minZoom: 0.5,
                maxZoom: 10,
                zoomScaleSensitivity: 0.4
              });
            } else {
              console.warn('svgPanZoom ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
          } catch (err) {
            console.error('svgPanZoom åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', err);
          }

        })
        .catch(err => {
          console.error("SVGã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", err);
          mapDiv.innerHTML = "<p>åœ°å›³ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‚ç…§ï¼‰ã€‚</p>";
        });


      // --- è¿½åŠ æ©Ÿèƒ½ï¼ˆåœ°å›³ä¸Šã®é ˜åŸŸã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãã®å›½ã®çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ç­‰ï¼‰ ---
      // ã‚‚ã—åœ°å›³ä¸Šã‚’ç›´æ¥ã‚¿ãƒƒãƒ—ã§å¤‰æ›´ã—ãŸã„å ´åˆã¯ã“ã“ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã§ãã¾ã™ã€‚
      // ä¾‹ï¼ˆã‚¿ãƒƒãƒ—ã§ã€Œæœªè¸â†’çµŒç”±â†’è¨ªå•â†’å®¿æ³Šã€ã®é †ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ç°¡æ˜“å‡¦ç†ï¼‰ï¼š
      mapDiv.addEventListener('click', (ev) => {
        // ã‚¯ãƒªãƒƒã‚¯å¯¾è±¡ãŒSVGè¦ç´ ï¼ˆpathã‚„rectãªã©ï¼‰ãªã‚‰å‡¦ç†ã™ã‚‹
        let target = ev.target;
        if (!target) return;
        // SVGå†…ã®è¦ç´ ã¯ <path>, <rect> ãªã©ãŒæƒ³å®š
        const svgEl = target.closest && target.closest('#worldSVG');
        if (!svgEl) return;

        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ ã®idã‚’å–å¾—
        const clickedId = target.id;
        if (!clickedId) return;

        // id ã‹ã‚‰å›½åã‚’é€†å¼•ãï¼ˆcountryIdMap ã®åè»¢ï¼‰
        const country = Object.keys(countryIdMap).find(k => countryIdMap[k] === clickedId);
        if (!country) return;

        // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—ã€æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«åˆ‡ã‚Šæ›¿ãˆ
        const currentStatus = JSON.parse(localStorage.getItem('countryStatus')) || {};
        const levels = ["æœªè¸","çµŒç”±","è¨ªå•","å®¿æ³Š"];
        const cur = currentStatus[country] || "æœªè¸";
        const next = levels[(levels.indexOf(cur) + 1) % levels.length];
        currentStatus[country] = next;
        localStorage.setItem('countryStatus', JSON.stringify(currentStatus));

        // è‰²ã¨ã‚¹ã‚³ã‚¢ã‚’å³æ™‚æ›´æ–°
        const el = document.getElementById(clickedId);
        if (el) el.setAttribute('fill', colors[next]);
        // ç·ã‚¹ã‚³ã‚¢å†è¨ˆç®—
        let tot = 0;
        for (const lv of Object.values(currentStatus)) tot += scores[lv] || 0;
        totalScoreEl.textContent = tot;
      });

    }); // DOMContentLoaded end
  </script>
</body>
</html>
